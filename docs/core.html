---

title: Core


keywords: fastai
sidebar: home_sidebar

summary: "I guess we'll do everything in one notebook to start with??"
description: "I guess we'll do everything in one notebook to start with??"
nb_path: "nbs/00_core.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/00_core.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pprint</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Parameter-keys">Parameter keys<a class="anchor-link" href="#Parameter-keys"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="DixonColesParameterKey" class="doc_header"><code>class</code> <code>DixonColesParameterKey</code><a href="https://github.com/Torvaney/mezzala/tree/master/mezzala/core.py#L24" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>DixonColesParameterKey</code>(<strong><code>label</code></strong>:<code>Hashable</code>)</p>
</blockquote>
<p>DixonColesParameterKey(label: Hashable)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="offence_key" class="doc_header"><code>offence_key</code><a href="https://github.com/Torvaney/mezzala/tree/master/mezzala/core.py#L37" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>offence_key</code>(<strong><code>label</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="defence_key" class="doc_header"><code>defence_key</code><a href="https://github.com/Torvaney/mezzala/tree/master/mezzala/core.py#L41" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>defence_key</code>(<strong><code>label</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Weights">Weights<a class="anchor-link" href="#Weights"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="UniformWeight" class="doc_header"><code>class</code> <code>UniformWeight</code><a href="https://github.com/Torvaney/mezzala/tree/master/mezzala/core.py#L46" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>UniformWeight</code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ExponentialWeight" class="doc_header"><code>class</code> <code>ExponentialWeight</code><a href="https://github.com/Torvaney/mezzala/tree/master/mezzala/core.py#L52" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ExponentialWeight</code>(<strong><code>epsilon</code></strong>, <strong><code>key</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Data-Adapters">Data Adapters<a class="anchor-link" href="#Data-Adapters"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">KeyAdapter</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">home_team</span><span class="p">,</span> <span class="n">away_team</span><span class="p">,</span> <span class="n">home_goals</span><span class="p">,</span> <span class="n">away_goals</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_home_team</span> <span class="o">=</span> <span class="n">home_team</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_away_team</span> <span class="o">=</span> <span class="n">away_team</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_home_goals</span> <span class="o">=</span> <span class="n">home_goals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_away_goals</span> <span class="o">=</span> <span class="n">away_goals</span>

    <span class="k">def</span> <span class="nf">_get_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">d</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">item</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">home_team</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_in</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_home_team</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">away_team</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_in</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_away_team</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">home_goals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_in</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_home_goals</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">away_goals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_in</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_away_goals</span><span class="p">)</span>      
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">AttributeAdapter</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">home_team</span><span class="p">,</span> <span class="n">away_team</span><span class="p">,</span> <span class="n">home_goals</span><span class="p">,</span> <span class="n">away_goals</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_home_team</span> <span class="o">=</span> <span class="n">home_team</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_away_team</span> <span class="o">=</span> <span class="n">away_team</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_home_goals</span> <span class="o">=</span> <span class="n">home_goals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_away_goals</span> <span class="o">=</span> <span class="n">away_goals</span>

    <span class="k">def</span> <span class="nf">home_team</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_home_team</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">away_team</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_away_team</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">home_goals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_home_goals</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">away_goals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_away_goals</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">LumpedAdapter</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Lump teams who appear below `min_matches` times (default 10) into one team &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_adapter</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">min_matches</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">placeholder</span><span class="o">=</span><span class="n">DixonColesParameterKey</span><span class="p">(</span><span class="s1">&#39;Other team&#39;</span><span class="p">)):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_adapter</span> <span class="o">=</span> <span class="n">base_adapter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_matches</span> <span class="o">=</span> <span class="n">min_matches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">placeholder</span> <span class="o">=</span> <span class="n">placeholder</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">match_count</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">home_team</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">home_team</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_adapter</span><span class="o">.</span><span class="n">home_team</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_count</span><span class="p">[</span><span class="n">home_team</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_matches</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">placeholder</span>
        <span class="k">return</span> <span class="n">home_team</span>

    <span class="k">def</span> <span class="nf">away_team</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">away_team</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_adapter</span><span class="o">.</span><span class="n">away_team</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_count</span><span class="p">[</span><span class="n">away_team</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_matches</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">placeholder</span>
        <span class="k">return</span> <span class="n">away_team</span>

    <span class="k">def</span> <span class="nf">home_goals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_adapter</span><span class="o">.</span><span class="n">home_goals</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">away_goals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_adapter</span><span class="o">.</span><span class="n">away_goals</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">home_match_count</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_adapter</span><span class="o">.</span><span class="n">home_team</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">away_match_count</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_adapter</span><span class="o">.</span><span class="n">away_team</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">match_count</span> <span class="o">=</span> <span class="n">home_match_count</span> <span class="o">+</span> <span class="n">away_match_count</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Modelling">Modelling<a class="anchor-link" href="#Modelling"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">DixonColesError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">DixonColesABC</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A mixin containing fitting mechanics for variations of Dixon-Coles models</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">UniformWeight</span><span class="p">()</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">parse_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Construct parameter keys and constraints from data. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parameter_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="n">parameter_keys</span><span class="p">,</span> <span class="n">constraints</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">home_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">away_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">home_goals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">away_goals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="c1"># Core methods</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_assign_params</span><span class="p">(</span><span class="n">param_keys</span><span class="p">,</span> <span class="n">param_values</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">param_keys</span><span class="p">,</span> <span class="n">param_values</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_tau</span><span class="p">(</span><span class="n">home_goals</span><span class="p">,</span> <span class="n">away_goals</span><span class="p">,</span> <span class="n">home_rate</span><span class="p">,</span> <span class="n">away_rate</span><span class="p">,</span> <span class="n">rho</span><span class="p">):</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">home_goals</span><span class="p">))</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">home_goals</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">away_goals</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">home_rate</span><span class="o">*</span><span class="n">away_rate</span><span class="o">*</span><span class="n">rho</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">home_goals</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">away_goals</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">home_rate</span><span class="o">*</span><span class="n">rho</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">home_goals</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">away_goals</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">away_rate</span><span class="o">*</span><span class="n">rho</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">home_goals</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">away_goals</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">rho</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tau</span>

    <span class="k">def</span> <span class="nf">_log_like</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">home_goals</span><span class="p">,</span> <span class="n">away_goals</span><span class="p">,</span> <span class="n">home_rate</span><span class="p">,</span> <span class="n">away_rate</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rho</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">RHO_KEY</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DixonColesError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Unable to find </span><span class="si">{</span><span class="n">RHO_KEY</span><span class="si">}</span><span class="s1"> in parameter set. Is it set in `parse_params`?&#39;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">poisson</span><span class="o">.</span><span class="n">logpmf</span><span class="p">(</span><span class="n">home_goals</span><span class="p">,</span> <span class="n">home_rate</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">poisson</span><span class="o">.</span><span class="n">logpmf</span><span class="p">(</span><span class="n">away_goals</span><span class="p">,</span> <span class="n">away_rate</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tau</span><span class="p">(</span><span class="n">home_goals</span><span class="p">,</span> <span class="n">away_goals</span><span class="p">,</span> <span class="n">home_rate</span><span class="p">,</span> <span class="n">away_rate</span><span class="p">,</span> <span class="n">rho</span><span class="p">))</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">objective_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">param_keys</span><span class="p">,</span> <span class="n">xs</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_params</span><span class="p">(</span><span class="n">param_keys</span><span class="p">,</span> <span class="n">xs</span><span class="p">)</span>

        <span class="n">home_goals</span><span class="p">,</span> <span class="n">away_goals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="n">home_rate</span><span class="p">,</span> <span class="n">away_rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

        <span class="c1"># NOTE: Should data adapter define the iteration?</span>
        <span class="c1"># E.g. dataframe adapter?</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="n">home_goals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">home_goals</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="n">away_goals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">away_goals</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="n">home_rate</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">home_rate</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
            <span class="n">away_rate</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">away_rate</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
            <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="n">log_like</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_like</span><span class="p">(</span><span class="n">home_goals</span><span class="p">,</span> <span class="n">away_goals</span><span class="p">,</span> <span class="n">home_rate</span><span class="p">,</span> <span class="n">away_rate</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

        <span class="n">pseudo_log_like</span> <span class="o">=</span> <span class="n">log_like</span> <span class="o">*</span> <span class="n">weights</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pseudo_log_like</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">param_keys</span><span class="p">,</span> <span class="n">constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_params</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="n">init_params</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">param_keys</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
            <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_keys</span><span class="p">))</span>
        <span class="p">)</span>

        <span class="c1"># Optimise!</span>
        <span class="n">estimate</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">xs</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective_fn</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">param_keys</span><span class="p">,</span> <span class="n">xs</span><span class="p">),</span>
            <span class="n">x0</span><span class="o">=</span><span class="n">init_params</span><span class="p">,</span>
            <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="c1"># Parse the estimates into parameter map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_params</span><span class="p">(</span><span class="n">param_keys</span><span class="p">,</span> <span class="n">estimate</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">predict_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">up_to</span><span class="o">=</span><span class="mi">26</span><span class="p">):</span>
        <span class="n">scorelines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">up_to</span><span class="p">),</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

        <span class="n">home_goals</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span> <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">scorelines</span><span class="p">]</span>
        <span class="n">away_goals</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">scorelines</span><span class="p">]</span>
        <span class="n">home_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">home_rate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
        <span class="n">away_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">away_rate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>

        <span class="n">probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_like</span><span class="p">(</span><span class="n">home_goals</span><span class="p">,</span> <span class="n">away_goals</span><span class="p">,</span> <span class="n">home_rate</span><span class="p">,</span> <span class="n">away_rate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">))</span>

        <span class="c1"># TODO: add a mixin/adapter to customise the indexing in the results dicts?</span>
        <span class="c1"># OR just use a custom dataclass for these...</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;home_goals&#39;</span><span class="p">,</span> <span class="s1">&#39;away_goals&#39;</span><span class="p">,</span> <span class="s1">&#39;probability&#39;</span><span class="p">],</span> <span class="n">vals</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">vals</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">home_goals</span><span class="p">,</span> <span class="n">away_goals</span><span class="p">,</span> <span class="n">probs</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">up_to</span><span class="o">=</span><span class="mi">26</span><span class="p">):</span>
        <span class="n">scorelines</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">predict_one</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">up_to</span><span class="o">=</span><span class="n">up_to</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">scorelines</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">DixonColes</span><span class="p">(</span><span class="n">DixonColesABC</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">UniformWeight</span><span class="p">(),</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">adapter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span>

    <span class="k">def</span> <span class="nf">home_team</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the home team &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapter</span><span class="o">.</span><span class="n">home_team</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">away_team</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the away team &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapter</span><span class="o">.</span><span class="n">away_team</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">home_goals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns home goals scored &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapter</span><span class="o">.</span><span class="n">home_goals</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">away_goals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns away goals scored &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapter</span><span class="o">.</span><span class="n">away_goals</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">parse_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a tuple of (parameter_names, [constraints]) &quot;&quot;&quot;</span>
        <span class="n">teams</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">home_team</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">away_team</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">n_teams</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">teams</span><span class="p">)</span>

        <span class="n">offence</span> <span class="o">=</span> <span class="p">[</span><span class="n">offence_key</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">teams</span><span class="p">]</span>
        <span class="n">defence</span> <span class="o">=</span> <span class="p">[</span><span class="n">defence_key</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">teams</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">offence</span> <span class="o">+</span> <span class="n">defence</span> <span class="o">+</span> <span class="p">[</span><span class="n">HFA_KEY</span><span class="p">,</span> <span class="n">RHO_KEY</span><span class="p">],</span>
            <span class="p">[</span>
                <span class="c1"># Force team offence parameters to average to 1</span>
                <span class="p">{</span><span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n_teams</span><span class="p">])),</span>
                 <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">},</span>
            <span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">home_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns home goalscoring rate &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
            <span class="n">params</span><span class="p">[</span><span class="n">offence_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">home_team</span><span class="p">(</span><span class="n">row</span><span class="p">))]</span> <span class="o">+</span>
            <span class="n">params</span><span class="p">[</span><span class="n">defence_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">away_team</span><span class="p">(</span><span class="n">row</span><span class="p">))]</span> <span class="o">+</span>
            <span class="n">params</span><span class="p">[</span><span class="n">HFA_KEY</span><span class="p">]</span> <span class="o">+</span>
            <span class="n">params</span><span class="p">[</span><span class="n">AVG_KEY</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">away_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns away goalscoring rate &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
            <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">offence_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">away_team</span><span class="p">(</span><span class="n">row</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_OFF</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">defence_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">home_team</span><span class="p">(</span><span class="n">row</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_DEF</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">params</span><span class="p">[</span><span class="n">AVG_KEY</span><span class="p">]</span>
        <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Example model fit</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;../data/premier-league-1516.json&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pl_1516</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    
<span class="n">pl_1516</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[{&#39;date&#39;: &#39;2015-08-08&#39;,
  &#39;team1&#39;: &#39;Manchester United FC&#39;,
  &#39;team2&#39;: &#39;Tottenham Hotspur FC&#39;,
  &#39;score&#39;: {&#39;ft&#39;: [1, 0]}},
 {&#39;date&#39;: &#39;2015-08-08&#39;,
  &#39;team1&#39;: &#39;AFC Bournemouth&#39;,
  &#39;team2&#39;: &#39;Aston Villa FC&#39;,
  &#39;score&#39;: {&#39;ft&#39;: [0, 1]}},
 {&#39;date&#39;: &#39;2015-08-08&#39;,
  &#39;team1&#39;: &#39;Leicester City FC&#39;,
  &#39;team2&#39;: &#39;Sunderland AFC&#39;,
  &#39;score&#39;: {&#39;ft&#39;: [4, 2]}}]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">DixonColes</span><span class="p">(</span>
    <span class="n">adapter</span><span class="o">=</span><span class="n">KeyAdapter</span><span class="p">(</span>
        <span class="n">home_team</span><span class="o">=</span><span class="s1">&#39;team1&#39;</span><span class="p">,</span>
        <span class="n">away_team</span><span class="o">=</span><span class="s1">&#39;team2&#39;</span><span class="p">,</span>
        <span class="n">home_goals</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">,</span> <span class="s1">&#39;ft&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="n">away_goals</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">,</span> <span class="s1">&#39;ft&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">pl_1516</span><span class="p">)</span>

<span class="c1"># All estimates should be valid numbers</span>
<span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

<span class="c1"># Home advantage should be positive</span>
<span class="k">assert</span> <span class="mf">1.0</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">HFA_KEY</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">2.0</span>

<span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/Users/ben/code/mezzala/venv/lib/python3.7/site-packages/ipykernel_launcher.py:40: RuntimeWarning: overflow encountered in multiply
/Users/ben/code/mezzala/venv/lib/python3.7/site-packages/ipykernel_launcher.py:57: RuntimeWarning: invalid value encountered in log
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>{DixonColesParameterKey(label=&#39;Rho&#39;): 0.9390832263308485,
 DixonColesParameterKey(label=&#39;Home-field advantage&#39;): 1.2345780660052648,
 DixonColesParameterKey(label=&#39;Average rate&#39;): 1.1692026726380644,
 (DixonColesParameterKey(label=&#39;Defence&#39;), &#39;Arsenal FC&#39;): 0.7396062391427994,
 (DixonColesParameterKey(label=&#39;Defence&#39;), &#39;Newcastle United FC&#39;): 1.3002453428513896,
 (DixonColesParameterKey(label=&#39;Offence&#39;), &#39;AFC Bournemouth&#39;): 0.8917281557631663,
 (DixonColesParameterKey(label=&#39;Offence&#39;), &#39;Arsenal FC&#39;): 1.254543653711057,
 (DixonColesParameterKey(label=&#39;Offence&#39;), &#39;Aston Villa FC&#39;): 0.5400583977176606,
 (DixonColesParameterKey(label=&#39;Offence&#39;), &#39;Chelsea FC&#39;): 1.1527088359171551,
 (DixonColesParameterKey(label=&#39;Defence&#39;), &#39;Aston Villa FC&#39;): 1.4948496974790357,
 (DixonColesParameterKey(label=&#39;Defence&#39;), &#39;Chelsea FC&#39;): 1.0779599286097092,
 (DixonColesParameterKey(label=&#39;Defence&#39;), &#39;Crystal Palace FC&#39;): 1.0158359461858912,
 (DixonColesParameterKey(label=&#39;Defence&#39;), &#39;Everton FC&#39;): 1.1248730392824013,
 (DixonColesParameterKey(label=&#39;Defence&#39;), &#39;Leicester City FC&#39;): 0.7333445511740386,
 (DixonColesParameterKey(label=&#39;Defence&#39;), &#39;Manchester United FC&#39;): 0.700831007427605,
 (DixonColesParameterKey(label=&#39;Defence&#39;), &#39;Southampton FC&#39;): 0.8301261610063928,
 (DixonColesParameterKey(label=&#39;Offence&#39;), &#39;Crystal Palace FC&#39;): 0.7574091764407477,
 (DixonColesParameterKey(label=&#39;Offence&#39;), &#39;Everton FC&#39;): 1.1625705611178487,
 (DixonColesParameterKey(label=&#39;Offence&#39;), &#39;Leicester City FC&#39;): 1.3093160799916825,
 (DixonColesParameterKey(label=&#39;Offence&#39;), &#39;Liverpool FC&#39;): 1.2312248231658878,
 (DixonColesParameterKey(label=&#39;Offence&#39;), &#39;Manchester City FC&#39;): 1.3813657141743394,
 (DixonColesParameterKey(label=&#39;Offence&#39;), &#39;Manchester United FC&#39;): 0.9446731646446328,
 (DixonColesParameterKey(label=&#39;Defence&#39;), &#39;Manchester City FC&#39;): 0.8508131767814932,
 (DixonColesParameterKey(label=&#39;Defence&#39;), &#39;Tottenham Hotspur FC&#39;): 0.7213273231894216,
 (DixonColesParameterKey(label=&#39;Defence&#39;), &#39;Watford FC&#39;): 0.9973643507155522,
 (DixonColesParameterKey(label=&#39;Offence&#39;), &#39;Newcastle United FC&#39;): 0.8678931837227595,
 (DixonColesParameterKey(label=&#39;Offence&#39;), &#39;Norwich City FC&#39;): 0.7672864285642997,
 (DixonColesParameterKey(label=&#39;Offence&#39;), &#39;Southampton FC&#39;): 1.136025054872852,
 (DixonColesParameterKey(label=&#39;Defence&#39;), &#39;AFC Bournemouth&#39;): 1.3445396929417222,
 (DixonColesParameterKey(label=&#39;Defence&#39;), &#39;Liverpool FC&#39;): 1.0156194067354147,
 (DixonColesParameterKey(label=&#39;Defence&#39;), &#39;Norwich City FC&#39;): 1.3296747206444828,
 (DixonColesParameterKey(label=&#39;Defence&#39;), &#39;Stoke City FC&#39;): 1.0934625731784549,
 (DixonColesParameterKey(label=&#39;Defence&#39;), &#39;Swansea City FC&#39;): 1.0367838339358382,
 (DixonColesParameterKey(label=&#39;Defence&#39;), &#39;West Ham United FC&#39;): 1.044682081548888,
 (DixonColesParameterKey(label=&#39;Offence&#39;), &#39;Stoke City FC&#39;): 0.8052869964389918,
 (DixonColesParameterKey(label=&#39;Defence&#39;), &#39;West Bromwich Albion FC&#39;): 0.9444466323366014,
 (DixonColesParameterKey(label=&#39;Offence&#39;), &#39;Sunderland AFC&#39;): 0.9396897073528556,
 (DixonColesParameterKey(label=&#39;Offence&#39;), &#39;Swansea City FC&#39;): 0.8181052878422405,
 (DixonColesParameterKey(label=&#39;Offence&#39;), &#39;Tottenham Hotspur FC&#39;): 1.3267946678982612,
 (DixonColesParameterKey(label=&#39;Offence&#39;), &#39;Watford FC&#39;): 0.7797696364231808,
 (DixonColesParameterKey(label=&#39;Offence&#39;), &#39;West Bromwich Albion FC&#39;): 0.6598512448800841,
 (DixonColesParameterKey(label=&#39;Offence&#39;), &#39;West Ham United FC&#39;): 1.2736992327310108,
 (DixonColesParameterKey(label=&#39;Defence&#39;), &#39;Sunderland AFC&#39;): 1.2466582860220832}
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">scorelines</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_one</span><span class="p">({</span>
    <span class="s1">&#39;team1&#39;</span><span class="p">:</span> <span class="s1">&#39;Manchester City FC&#39;</span><span class="p">,</span>
    <span class="s1">&#39;team2&#39;</span><span class="p">:</span> <span class="s1">&#39;Swansea City FC&#39;</span><span class="p">,</span>
<span class="p">})</span>

<span class="n">home_win</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;probability&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">scorelines</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;home_goals&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;away_goals&#39;</span><span class="p">])</span>
<span class="n">draw</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;probability&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">scorelines</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;home_goals&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;away_goals&#39;</span><span class="p">])</span>
<span class="n">away_win</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;probability&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">scorelines</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;home_goals&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;away_goals&#39;</span><span class="p">])</span>

<span class="n">home_win</span><span class="p">,</span> <span class="n">draw</span><span class="p">,</span> <span class="n">away_win</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(0.6645791886921023, 0.19833755250730678, 0.1370832588005913)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

