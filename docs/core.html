---

title: Core


keywords: fastai
sidebar: home_sidebar

summary: "Dixon-Coles models in Python"
description: "Dixon-Coles models in Python"
nb_path: "nbs/00_core.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/00_core.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dt</span>
<span class="kn">import</span> <span class="nn">pprint</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Weights">Weights<a class="anchor-link" href="#Weights"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="UniformWeight" class="doc_header"><code>class</code> <code>UniformWeight</code><a href="https://github.com/Torvaney/mezzala/tree/master/mezzala/__init__.py#L22" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>UniformWeight</code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ExponentialWeight" class="doc_header"><code>class</code> <code>ExponentialWeight</code><a href="https://github.com/Torvaney/mezzala/tree/master/mezzala/__init__.py#L28" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ExponentialWeight</code>(<strong><code>epsilon</code></strong>, <strong><code>key</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Parameter-keys">Parameter keys<a class="anchor-link" href="#Parameter-keys"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="DixonColesParameterKey" class="doc_header"><code>class</code> <code>DixonColesParameterKey</code><a href="https://github.com/Torvaney/mezzala/tree/master/mezzala/__init__.py#L39" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>DixonColesParameterKey</code>(<strong><code>label</code></strong>:<code>Hashable</code>)</p>
</blockquote>
<p>DixonColesParameterKey(label: Hashable)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Data-Adapters">Data Adapters<a class="anchor-link" href="#Data-Adapters"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="KeyAdapter" class="doc_header"><code>class</code> <code>KeyAdapter</code><a href="https://github.com/Torvaney/mezzala/tree/master/mezzala/__init__.py#L51" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>KeyAdapter</code>(<strong><code>home_team</code></strong>, <strong><code>away_team</code></strong>, <strong><code>home_goals</code></strong>, <strong><code>away_goals</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="AttributeAdapter" class="doc_header"><code>class</code> <code>AttributeAdapter</code><a href="https://github.com/Torvaney/mezzala/tree/master/mezzala/__init__.py#L78" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>AttributeAdapter</code>(<strong><code>home_team</code></strong>, <strong><code>away_team</code></strong>, <strong><code>home_goals</code></strong>, <strong><code>away_goals</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="LumpedAdapter" class="doc_header"><code>class</code> <code>LumpedAdapter</code><a href="https://github.com/Torvaney/mezzala/tree/master/mezzala/__init__.py#L100" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>LumpedAdapter</code>(<strong><code>base_adapter</code></strong>, <strong><code>data</code></strong>, <strong><code>min_matches</code></strong>=<em><code>10</code></em>, <strong><code>placeholder</code></strong>=<em><code>DixonColesParameterKey(label='Other team')</code></em>)</p>
</blockquote>
<p>Lump teams who appear below <code>min_matches</code> times (default 10) into one team</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Modelling">Modelling<a class="anchor-link" href="#Modelling"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="DixonColes" class="doc_header"><code>class</code> <code>DixonColes</code><a href="https://github.com/Torvaney/mezzala/tree/master/mezzala/__init__.py#L137" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>DixonColes</code>(<strong><code>adapter</code></strong>, <strong><code>blocks</code></strong>, <strong><code>weight</code></strong>=<em><code>&lt;mezzala.__init__.UniformWeight object at 0x12ac6c710&gt;</code></em>, <strong><code>params</code></strong>=<em><code>None</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Model-blocks">Model blocks<a class="anchor-link" href="#Model-blocks"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="BaseRate" class="doc_header"><code>class</code> <code>BaseRate</code><a href="https://github.com/Torvaney/mezzala/tree/master/mezzala/__init__.py#L285" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>BaseRate</code>() :: <a href="/mezzala/core.html#ModelBlockABC"><code>ModelBlockABC</code></a></p>
</blockquote>
<p>Base class for model blocks</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="HomeAdvantage" class="doc_header"><code>class</code> <code>HomeAdvantage</code><a href="https://github.com/Torvaney/mezzala/tree/master/mezzala/__init__.py#L301" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>HomeAdvantage</code>() :: <a href="/mezzala/core.html#ModelBlockABC"><code>ModelBlockABC</code></a></p>
</blockquote>
<p>Base class for model blocks</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="TeamStrength" class="doc_header"><code>class</code> <code>TeamStrength</code><a href="https://github.com/Torvaney/mezzala/tree/master/mezzala/__init__.py#L315" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>TeamStrength</code>() :: <a href="/mezzala/core.html#ModelBlockABC"><code>ModelBlockABC</code></a></p>
</blockquote>
<p>Base class for model blocks</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="KeyBlock" class="doc_header"><code>class</code> <code>KeyBlock</code><a href="https://github.com/Torvaney/mezzala/tree/master/mezzala/__init__.py#L364" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>KeyBlock</code>(<strong><code>key</code></strong>) :: <a href="/mezzala/core.html#ModelBlockABC"><code>ModelBlockABC</code></a></p>
</blockquote>
<p>Generic model block for adding arbitrary model terms to both home and away team</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Example model fit</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;../data/premier-league-1516.json&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pl_1516</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="c1"># Let&#39;s parse the dates, too</span>
<span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">pl_1516</span><span class="p">:</span>
    <span class="n">match</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">match</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
    
<span class="n">pl_1516</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[{&#39;date&#39;: datetime.datetime(2015, 8, 8, 0, 0),
  &#39;team1&#39;: &#39;Manchester United FC&#39;,
  &#39;team2&#39;: &#39;Tottenham Hotspur FC&#39;,
  &#39;score&#39;: {&#39;ft&#39;: [1, 0]}},
 {&#39;date&#39;: datetime.datetime(2015, 8, 8, 0, 0),
  &#39;team1&#39;: &#39;AFC Bournemouth&#39;,
  &#39;team2&#39;: &#39;Aston Villa FC&#39;,
  &#39;score&#39;: {&#39;ft&#39;: [0, 1]}},
 {&#39;date&#39;: datetime.datetime(2015, 8, 8, 0, 0),
  &#39;team1&#39;: &#39;Leicester City FC&#39;,
  &#39;team2&#39;: &#39;Sunderland AFC&#39;,
  &#39;score&#39;: {&#39;ft&#39;: [4, 2]}}]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">DixonColes</span><span class="p">(</span>
    <span class="n">adapter</span><span class="o">=</span><span class="n">KeyAdapter</span><span class="p">(</span>
        <span class="n">home_team</span><span class="o">=</span><span class="s1">&#39;team1&#39;</span><span class="p">,</span>
        <span class="n">away_team</span><span class="o">=</span><span class="s1">&#39;team2&#39;</span><span class="p">,</span>
        <span class="n">home_goals</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">,</span> <span class="s1">&#39;ft&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="n">away_goals</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">,</span> <span class="s1">&#39;ft&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="p">),</span>
    <span class="n">blocks</span><span class="o">=</span><span class="p">[</span><span class="n">TeamStrength</span><span class="p">(),</span> <span class="n">BaseRate</span><span class="p">(),</span> <span class="n">HomeAdvantage</span><span class="p">()]</span>
<span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">pl_1516</span><span class="p">)</span>

<span class="c1"># All estimates should be valid numbers</span>
<span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

<span class="c1"># Home advantage should be positive</span>
<span class="k">assert</span> <span class="mf">1.0</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">HFA_KEY</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">2.0</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/Users/ben/code/mezzala/venv/lib/python3.7/site-packages/ipykernel_launcher.py:54: RuntimeWarning: overflow encountered in multiply
/Users/ben/code/mezzala/venv/lib/python3.7/site-packages/ipykernel_launcher.py:65: RuntimeWarning: invalid value encountered in log
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">param_keys</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="n">param_key_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">label</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">param_keys</span><span class="p">)</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">param_keys</span><span class="p">:</span>
    <span class="n">key_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">param_key_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key_str</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="si">:</span><span class="s1">0.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>(&#39;Offence&#39;, &#39;Chelsea FC&#39;)              : 1.15
(&#39;Offence&#39;, &#39;Newcastle United FC&#39;)     : 0.87
(&#39;Offence&#39;, &#39;Crystal Palace FC&#39;)       : 0.76
(&#39;Offence&#39;, &#39;Liverpool FC&#39;)            : 1.23
(&#39;Offence&#39;, &#39;Manchester City FC&#39;)      : 1.38
(&#39;Offence&#39;, &#39;Everton FC&#39;)              : 1.16
(&#39;Offence&#39;, &#39;West Ham United FC&#39;)      : 1.27
(&#39;Offence&#39;, &#39;AFC Bournemouth&#39;)         : 0.89
(&#39;Offence&#39;, &#39;Swansea City FC&#39;)         : 0.82
(&#39;Offence&#39;, &#39;Aston Villa FC&#39;)          : 0.54
(&#39;Offence&#39;, &#39;Southampton FC&#39;)          : 1.14
(&#39;Offence&#39;, &#39;Stoke City FC&#39;)           : 0.81
(&#39;Offence&#39;, &#39;Arsenal FC&#39;)              : 1.25
(&#39;Offence&#39;, &#39;Manchester United FC&#39;)    : 0.94
(&#39;Offence&#39;, &#39;Sunderland AFC&#39;)          : 0.94
(&#39;Offence&#39;, &#39;Watford FC&#39;)              : 0.78
(&#39;Offence&#39;, &#39;Leicester City FC&#39;)       : 1.31
(&#39;Offence&#39;, &#39;Tottenham Hotspur FC&#39;)    : 1.33
(&#39;Offence&#39;, &#39;Norwich City FC&#39;)         : 0.77
(&#39;Offence&#39;, &#39;West Bromwich Albion FC&#39;) : 0.66
(&#39;Defence&#39;, &#39;Chelsea FC&#39;)              : 1.08
(&#39;Defence&#39;, &#39;Newcastle United FC&#39;)     : 1.30
(&#39;Defence&#39;, &#39;Crystal Palace FC&#39;)       : 1.02
(&#39;Defence&#39;, &#39;Liverpool FC&#39;)            : 1.02
(&#39;Defence&#39;, &#39;Manchester City FC&#39;)      : 0.85
(&#39;Defence&#39;, &#39;Everton FC&#39;)              : 1.12
(&#39;Defence&#39;, &#39;West Ham United FC&#39;)      : 1.04
(&#39;Defence&#39;, &#39;AFC Bournemouth&#39;)         : 1.34
(&#39;Defence&#39;, &#39;Swansea City FC&#39;)         : 1.04
(&#39;Defence&#39;, &#39;Aston Villa FC&#39;)          : 1.49
(&#39;Defence&#39;, &#39;Southampton FC&#39;)          : 0.83
(&#39;Defence&#39;, &#39;Stoke City FC&#39;)           : 1.09
(&#39;Defence&#39;, &#39;Arsenal FC&#39;)              : 0.74
(&#39;Defence&#39;, &#39;Manchester United FC&#39;)    : 0.70
(&#39;Defence&#39;, &#39;Sunderland AFC&#39;)          : 1.25
(&#39;Defence&#39;, &#39;Watford FC&#39;)              : 1.00
(&#39;Defence&#39;, &#39;Leicester City FC&#39;)       : 0.73
(&#39;Defence&#39;, &#39;Tottenham Hotspur FC&#39;)    : 0.72
(&#39;Defence&#39;, &#39;Norwich City FC&#39;)         : 1.33
(&#39;Defence&#39;, &#39;West Bromwich Albion FC&#39;) : 0.94
Average rate                           : 1.17
Home-field advantage                   : 1.23
Rho                                    : 0.94
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Making predictions for a single match</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">scorelines</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_one</span><span class="p">({</span>
    <span class="s1">&#39;team1&#39;</span><span class="p">:</span> <span class="s1">&#39;Manchester City FC&#39;</span><span class="p">,</span>
    <span class="s1">&#39;team2&#39;</span><span class="p">:</span> <span class="s1">&#39;Swansea City FC&#39;</span><span class="p">,</span>
<span class="p">})</span>

<span class="n">home_win</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;probability&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">scorelines</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;home_goals&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;away_goals&#39;</span><span class="p">])</span>
<span class="n">draw</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;probability&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">scorelines</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;home_goals&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;away_goals&#39;</span><span class="p">])</span>
<span class="n">away_win</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;probability&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">scorelines</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;home_goals&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;away_goals&#39;</span><span class="p">])</span>

<span class="n">home_win</span><span class="p">,</span> <span class="n">draw</span><span class="p">,</span> <span class="n">away_win</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(0.6645794578795163, 0.19833741652954348, 0.13708312559093988)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Or for multiple matches</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">many_scorelines</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">([</span>
    <span class="p">{</span><span class="s1">&#39;team1&#39;</span><span class="p">:</span> <span class="s1">&#39;Manchester City FC&#39;</span><span class="p">,</span>
     <span class="s1">&#39;team2&#39;</span><span class="p">:</span> <span class="s1">&#39;Swansea City FC&#39;</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;team1&#39;</span><span class="p">:</span> <span class="s1">&#39;Manchester City FC&#39;</span><span class="p">,</span>
     <span class="s1">&#39;team2&#39;</span><span class="p">:</span> <span class="s1">&#39;West Ham United FC&#39;</span><span class="p">}</span>
<span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>What about a model with a different weighting method?</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">season_end_date</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">match</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">pl_1516</span><span class="p">)</span>

<span class="n">model_exp</span> <span class="o">=</span> <span class="n">DixonColes</span><span class="p">(</span>
    <span class="n">adapter</span><span class="o">=</span><span class="n">KeyAdapter</span><span class="p">(</span>
        <span class="n">home_team</span><span class="o">=</span><span class="s1">&#39;team1&#39;</span><span class="p">,</span>
        <span class="n">away_team</span><span class="o">=</span><span class="s1">&#39;team2&#39;</span><span class="p">,</span>
        <span class="n">home_goals</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">,</span> <span class="s1">&#39;ft&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="n">away_goals</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">,</span> <span class="s1">&#39;ft&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="p">),</span>
    <span class="n">blocks</span><span class="o">=</span><span class="p">[</span><span class="n">TeamStrength</span><span class="p">(),</span> <span class="n">BaseRate</span><span class="p">(),</span> <span class="n">HomeAdvantage</span><span class="p">()],</span>
    <span class="n">weight</span><span class="o">=</span><span class="n">ExponentialWeight</span><span class="p">(</span>
        <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.0065</span><span class="p">,</span>  <span class="c1"># Value taken from the original paper</span>
        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">season_end_date</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">days</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">model_exp</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">pl_1516</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/Users/ben/code/mezzala/venv/lib/python3.7/site-packages/ipykernel_launcher.py:38: RuntimeWarning: overflow encountered in exp
/Users/ben/code/mezzala/venv/lib/python3.7/site-packages/ipykernel_launcher.py:43: RuntimeWarning: overflow encountered in exp
/Users/ben/code/mezzala/venv/lib/python3.7/site-packages/scipy/stats/_discrete_distns.py:763: RuntimeWarning: invalid value encountered in subtract
  Pk = special.xlogy(k, mu) - gamln(k + 1) - mu
/Users/ben/code/mezzala/venv/lib/python3.7/site-packages/ipykernel_launcher.py:56: RuntimeWarning: overflow encountered in multiply
/Users/ben/code/mezzala/venv/lib/python3.7/site-packages/ipykernel_launcher.py:65: RuntimeWarning: invalid value encountered in log
/Users/ben/code/mezzala/venv/lib/python3.7/site-packages/ipykernel_launcher.py:65: RuntimeWarning: invalid value encountered in add
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;__main__.DixonColes at 0x127f2b550&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>How much does that change the ratings at season-end?</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">param_keys</span><span class="p">:</span>
    <span class="n">key_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">param_key_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">model_param</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
    <span class="n">model_exp_param</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">model_exp</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key_str</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">model_param</span><span class="si">:</span><span class="s1">0.2f</span><span class="si">}</span><span class="s1"> -&gt; </span><span class="si">{</span><span class="n">model_exp_param</span><span class="si">:</span><span class="s1">0.2f</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">model_exp_param</span><span class="o">/</span><span class="n">model_param</span><span class="si">:</span><span class="s1">0.2f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>(&#39;Offence&#39;, &#39;Chelsea FC&#39;)              : 1.15 -&gt; 1.12 (0.97)
(&#39;Offence&#39;, &#39;Newcastle United FC&#39;)     : 0.87 -&gt; 0.82 (0.94)
(&#39;Offence&#39;, &#39;Crystal Palace FC&#39;)       : 0.76 -&gt; 0.85 (1.12)
(&#39;Offence&#39;, &#39;Liverpool FC&#39;)            : 1.23 -&gt; 1.06 (0.86)
(&#39;Offence&#39;, &#39;Manchester City FC&#39;)      : 1.38 -&gt; 1.46 (1.06)
(&#39;Offence&#39;, &#39;Everton FC&#39;)              : 1.16 -&gt; 1.28 (1.10)
(&#39;Offence&#39;, &#39;West Ham United FC&#39;)      : 1.27 -&gt; 1.27 (1.00)
(&#39;Offence&#39;, &#39;AFC Bournemouth&#39;)         : 0.89 -&gt; 0.88 (0.98)
(&#39;Offence&#39;, &#39;Swansea City FC&#39;)         : 0.82 -&gt; 0.79 (0.97)
(&#39;Offence&#39;, &#39;Aston Villa FC&#39;)          : 0.54 -&gt; 0.59 (1.10)
(&#39;Offence&#39;, &#39;Southampton FC&#39;)          : 1.14 -&gt; 1.06 (0.93)
(&#39;Offence&#39;, &#39;Stoke City FC&#39;)           : 0.81 -&gt; 0.76 (0.94)
(&#39;Offence&#39;, &#39;Arsenal FC&#39;)              : 1.25 -&gt; 1.24 (0.98)
(&#39;Offence&#39;, &#39;Manchester United FC&#39;)    : 0.94 -&gt; 0.96 (1.02)
(&#39;Offence&#39;, &#39;Sunderland AFC&#39;)          : 0.94 -&gt; 0.89 (0.95)
(&#39;Offence&#39;, &#39;Watford FC&#39;)              : 0.78 -&gt; 0.77 (0.99)
(&#39;Offence&#39;, &#39;Leicester City FC&#39;)       : 1.31 -&gt; 1.40 (1.07)
(&#39;Offence&#39;, &#39;Tottenham Hotspur FC&#39;)    : 1.33 -&gt; 1.27 (0.96)
(&#39;Offence&#39;, &#39;Norwich City FC&#39;)         : 0.77 -&gt; 0.86 (1.12)
(&#39;Offence&#39;, &#39;West Bromwich Albion FC&#39;) : 0.66 -&gt; 0.68 (1.02)
(&#39;Defence&#39;, &#39;Chelsea FC&#39;)              : 1.08 -&gt; 1.21 (1.12)
(&#39;Defence&#39;, &#39;Newcastle United FC&#39;)     : 1.30 -&gt; 1.38 (1.06)
(&#39;Defence&#39;, &#39;Crystal Palace FC&#39;)       : 1.02 -&gt; 0.93 (0.92)
(&#39;Defence&#39;, &#39;Liverpool FC&#39;)            : 1.02 -&gt; 0.97 (0.96)
(&#39;Defence&#39;, &#39;Manchester City FC&#39;)      : 0.85 -&gt; 0.79 (0.93)
(&#39;Defence&#39;, &#39;Everton FC&#39;)              : 1.12 -&gt; 1.08 (0.96)
(&#39;Defence&#39;, &#39;West Ham United FC&#39;)      : 1.04 -&gt; 1.00 (0.95)
(&#39;Defence&#39;, &#39;AFC Bournemouth&#39;)         : 1.34 -&gt; 1.35 (1.01)
(&#39;Defence&#39;, &#39;Swansea City FC&#39;)         : 1.04 -&gt; 1.04 (1.00)
(&#39;Defence&#39;, &#39;Aston Villa FC&#39;)          : 1.49 -&gt; 1.41 (0.95)
(&#39;Defence&#39;, &#39;Southampton FC&#39;)          : 0.83 -&gt; 0.89 (1.07)
(&#39;Defence&#39;, &#39;Stoke City FC&#39;)           : 1.09 -&gt; 0.98 (0.90)
(&#39;Defence&#39;, &#39;Arsenal FC&#39;)              : 0.74 -&gt; 0.73 (0.99)
(&#39;Defence&#39;, &#39;Manchester United FC&#39;)    : 0.70 -&gt; 0.67 (0.96)
(&#39;Defence&#39;, &#39;Sunderland AFC&#39;)          : 1.25 -&gt; 1.45 (1.17)
(&#39;Defence&#39;, &#39;Watford FC&#39;)              : 1.00 -&gt; 0.88 (0.89)
(&#39;Defence&#39;, &#39;Leicester City FC&#39;)       : 0.73 -&gt; 0.94 (1.28)
(&#39;Defence&#39;, &#39;Tottenham Hotspur FC&#39;)    : 0.72 -&gt; 0.67 (0.92)
(&#39;Defence&#39;, &#39;Norwich City FC&#39;)         : 1.33 -&gt; 1.40 (1.05)
(&#39;Defence&#39;, &#39;West Bromwich Albion FC&#39;) : 0.94 -&gt; 0.99 (1.04)
Average rate                           : 1.17 -&gt; 1.19 (1.02)
Home-field advantage                   : 1.23 -&gt; 1.16 (0.94)
Rho                                    : 0.94 -&gt; 0.95 (1.01)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And we should demo model blocks a bit more?</p>

</div>
</div>
</div>
</div>
 

